# Common Agent Rules (MIDAS Framework - Atlassian Integrated)

## Global Rules

*   **Status-Driven Handoffs:** Handoffs between primary sequential roles (e.g., Planner -> PO, PO -> Coder, Coder -> Tester, Tester -> Coder/DevOps) are generally triggered by setting the appropriate **Jira issue status** using `jira_transition_issue`. The MIDAS Orchestrator Agent detects this status change (via JQL queries in `jira_search`) and automatically initiates a `new_task` for the next agent. Avoid direct `new_task` calls for these sequential handoffs unless explicitly instructed otherwise. Ensure necessary context for the next agent is available within the Jira issue fields (including custom fields), comments, or linked Confluence pages.
*   **Avoid Duplication (Issues Management):** When creating new Jira issues (Epics, Stories, Tasks, Bugs), **FIRST** check for existing ones linked to the parent or related to the context using `jira_search` with appropriate JQL queries to prevent duplicates. Clearly state the rationale (avoiding duplication, ensuring consistency). If similar items exist, reference or update them using `jira_update_issue` or `jira_add_comment` instead of creating new ones.
*   **Avoid Duplication (Documentation Management):** Before creating new Confluence pages (Specs, ADRs, diagrams, guides), **FIRST** check for existing relevant pages using `confluence_search` or by checking links in the related Jira issue (`jira_get_issue`). Clearly state the rationale (avoiding duplication, ensuring consistency). If relevant pages exist, update them using `confluence_update_page` or reference them in the Jira issue instead of creating duplicates.
*   **Intra-Task Persona Shifts:** The `switch_mode` tool should ONLY be used for temporary changes in perspective or capability *within the same task instance* (e.g., Coder thinking like a Tester), not for handing off work between different agent roles.

## MANDATORY RULES

*   **Explain Your Actions:** When executing commands or making changes, explain the rationale behind your actions. This helps users understand the reasoning and context of your decisions.
*   **Tool Usage:** Use the appropriate tools for the task at hand. Examples include `read_file` (for local templates/files), `write_to_file`/`apply_diff` (for local file changes if needed), `execute_command` (for shell commands), and `mcp-atlassian` tools like `jira_create_issue`, `jira_update_issue`, `jira_add_comment`, `jira_search`, `jira_transition_issue`, `confluence_create_page`, `confluence_update_page`, `confluence_search`, `confluence_get_page`. Always check tool output and log errors. If a tool fails, log the error and attempt a safer method if available. If it still fails, report the failure clearly.
*   **File Naming Conventions:** Follow established conventions for any *local* files created or modified (e.g., temporary analysis files). Confluence page titles should be descriptive and follow project conventions.
*   **Error Handling:** If a command or tool fails, analyze the error output. If the cause is clear, attempt to fix it and retry once if appropriate. If the cause is unclear or the retry fails, log the command, the error, and report the failure clearly, often via a Jira comment (`jira_add_comment`) on the relevant issue.
*   **Conflicting Information:** If you detect conflicting information between Jira issues, Confluence pages, or instructions, prioritize the source of truth defined by the system or explicitly request clarification using `ask_followup_question` or `jira_add_comment`. Log the discrepancy if necessary.
*   **Loop Detection:** If you find yourself in a loop (e.g., repeating `jira_search` without progress), stop and reassess. Log the loop detection and, if unable to break it, report the problem.
*   **Keep Jira Issues Context Up-to-Date:** When working on a Jira Issue, ensure its context is current. Add relevant comments (`jira_add_comment`), link related issues (`jira_create_issue_link`), link relevant Confluence pages (via comments or custom fields), link PRs (via comments), and update the status (`jira_transition_issue`) as needed.
*   **Template Usage (Confluence):** For standard documentation types (ADRs, Specs, etc.), use templates from `.roo/templates/docs/`. Load the template using `read_file`, populate placeholders, and provide the final Markdown content to `confluence_create_page`.
*   **Jira Issue Structure:** When creating Jira issues (`jira_create_issue`), structure the `description` field clearly, including sections for Goals, Acceptance Criteria, Technical Notes, etc., as appropriate for the issue type. Ensure required fields (Project Key, Summary, Issue Type) are provided.
*   **Git Workflow Adherence:** Follow the defined Git workflow, including using Pull Requests for code changes (Coder). Link PRs to the relevant Jira issue using comments (`jira_add_comment`). Do not push code directly to main integration branches unless explicitly authorized.
*   **Context Retrieval:** When activated via `new_task`, expect minimal payload context (like `issue_key`). You are responsible for retrieving the full, necessary context from the specified Jira issue (`jira_get_issue` - check fields, description, comments), linked Confluence pages (`confluence_get_page`), and potentially linked PRs (`github/get_pull_request`) using the appropriate tools.
*   **Clarification:** If input specifications, Jira issue details, or Confluence page content are vague, ambiguous, or lack sufficient detail, **STOP** and use `ask_followup_question` or `jira_add_comment` to request clarification. Do NOT proceed with ambiguous requirements.