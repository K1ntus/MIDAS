# Common Agent Rules (MIDAS Framework)

## Global Rules

*   **Label-Driven Handoffs:** Handoffs between primary sequential roles (e.g., Planner -> PO, PO -> Coder, Coder -> Tester, Tester -> Coder/DevOps) are generally triggered by setting the appropriate `status:*` label on the relevant GitHub Issue using `github/update_issue`. The MIDAS Workflow Monitor (Orchestrator) detects this label change and automatically initiates a `new_task` for the next agent. Avoid direct `new_task` calls for these sequential handoffs unless explicitly instructed otherwise for specific non-standard workflows. Ensure necessary context for the next agent is available within the issue body or comments.
*   **Avoid Duplication (Issues Management):** When creating new issues (Epics, Stories, Tasks, Bugs), **FIRST** check for existing ones linked to the parent or related to the context using appropriate tools (`github/list_issues`, `github/search_issues`) to prevent duplicates. Clearly state the rationale (avoiding duplication, ensuring consistency). If similar items exist, reference or update them instead of creating new ones.
*   **Avoid Duplication (Documentation Management):** Before creating new documentation artifacts (Specs, ADRs, diagrams, guides), **FIRST** check for existing relevant artifacts using appropriate tools (`list_files`, `search_files`, `github/get_issue_comments`). Clearly state the rationale (avoiding duplication, ensuring consistency). If relevant artifacts exist, update or reference them instead of creating duplicates.
*   **Intra-Task Persona Shifts:** The `switch_mode` tool should ONLY be used for temporary changes in perspective or capability *within the same task instance* (e.g., Coder thinking like a Tester), not for handing off work between different agent roles.

## MANDATORY RULES

*   **Explain Your Actions:** When executing commands or making changes, explain the rationale behind your actions. This helps users understand the reasoning and context of your decisions.
*   **Tool Usage:** Use the appropriate tools for the task at hand. For example, use `read_file` to gather information from files, `write_to_file` or `apply_diff` for writing changes, and `execute_command` for running shell commands. Always check the tool's output and log any errors or unexpected results. If a tool fails, log the error and attempt the operation again using a safer method if available (e.g., switch from `apply_diff` to `write_to_file` for the whole file). If it still fails, escalate the issue or report the failure clearly.
*   **File Naming Conventions:** Follow the established file naming conventions for all files created or modified. This includes using consistent prefixes, suffixes, and formats to ensure easy identification and organization.
*   **Error Handling:** If a command or tool fails, analyze the error output. If the cause is clear (e.g., syntax error, missing dependency), attempt to fix it and retry the command once if appropriate. If the cause is unclear or the retry fails, log the command, the error, and escalate the issue or report the failure clearly, often via a GitHub comment (`github/add_issue_comment`) on the relevant issue.
*   **Conflicting Information:** If you detect conflicting information between different state files or instructions, prioritize the source of truth defined by the system or explicitly request clarification using `ask_followup_question`. Log the discrepancy if necessary.
*   **Loop Detection:** If you find yourself in a loop of asking for user input or repeating the same command without progress, stop and reassess your approach. Log the loop detection and, if unable to break the loop after a reasonable attempt, escalate the issue or report the problem.
*   **Keep Issues Context Up-to-Date:** When working on a GitHub Issue, ensure that the issue's context is kept current. This includes adding relevant comments, linking related issues/PRs, and updating the status/labels as needed. Use `github/add_issue_comment` to provide updates and context to the team.
*   **Template Usage:** Where applicable (e.g., creating specific issue types like Bugs, Vulnerabilities, Epics, Stories, Tasks), use the provided templates located in `.roo/templates/`. Load templates using `read_file` and populate them before using tools like `github/create_issue`. This ensures consistency and clarity.
*   **GitHub Workflow Adherence:** Follow the defined GitHub workflow, including using Pull Requests for code changes (Coder), appropriate labeling for status tracking, and linking related items. Do not push code directly to main integration branches unless explicitly authorized for a specific reason.
*   **Context Retrieval:** When activated via `new_task` (especially from the Orchestrator/Monitor), expect minimal payload context (like `issue_number`). You are responsible for retrieving the full, necessary context from the specified GitHub issue, its comments, linked PRs, and referenced documentation using tools like `github/get_issue`, `github/get_issue_comments`, `github/get_pull_request`, `read_file`, etc.
*   **Clarification:** If input specifications, issue details, or requirements are vague, ambiguous, or lack sufficient detail to proceed confidently, **STOP** and use the `ask_followup_question` tool to request clarification from the user or relevant agent via comments. Do NOT proceed with ambiguous requirements.